{
  "author": "",
  "category": "Movement",
  "extensionNamespace": "",
  "fullName": "Pixel perfect movement",
  "helpPath": "",
  "iconUrl": "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAyMy4wLjMsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iSWNvbnMiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgMzIgMzIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMyIDMyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KCS5zdDB7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoyO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoxMDt9DQoJLnN0MXtmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO30NCgkuc3Qye2ZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MjtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLWRhc2hhcnJheTo2LDY7fQ0KCS5zdDN7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoyO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtZGFzaGFycmF5OjQsNDt9DQoJLnN0NHtmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDA7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7fQ0KCS5zdDV7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoyO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1kYXNoYXJyYXk6My4xMDgxLDMuMTA4MTt9DQoJDQoJCS5zdDZ7ZmlsbDpub25lO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoyO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDoxMDtzdHJva2UtZGFzaGFycmF5OjQsMzt9DQo8L3N0eWxlPg0KPHJlY3QgeD0iNCIgeT0iNCIgY2xhc3M9InN0MCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ii8+DQo8bGluZSBjbGFzcz0ic3QwIiB4MT0iMTIiIHkxPSIyOCIgeDI9IjEyIiB5Mj0iNCIvPg0KPGxpbmUgY2xhc3M9InN0MCIgeDE9IjIwIiB5MT0iMjgiIHgyPSIyMCIgeTI9IjQiLz4NCjxsaW5lIGNsYXNzPSJzdDAiIHgxPSIyOCIgeTE9IjIwIiB4Mj0iNCIgeTI9IjIwIi8+DQo8bGluZSBjbGFzcz0ic3QwIiB4MT0iMjgiIHkxPSIxMiIgeDI9IjQiIHkyPSIxMiIvPg0KPC9zdmc+DQo=",
  "name": "PixelPerfectMovement",
  "previewIconUrl": "https://resources.gdevelop-app.com/assets/Icons/Line Hero Pack/Master/SVG/Graphic Design/Graphic Design_grid.svg",
  "shortDescription": "Grid-based or pixel perfect platformer and top-down movements.",
  "version": "0.2.0",
  "description": [
    "Games with pixel art usually use pixels bigger than actual pixels of the screen. This can lead to big pixels partially overlapping each other which doesn't look good.",
    "",
    "This extension allows to seamlessly keep big pixels aligned when the object is stopped and still beneficiate from the high resolution of the screen to have smooth movements.",
    "",
    "It can be used for:",
    "* Pixel-perfect platformers ([open the project online](https://editor.gdevelop.io/?project=example://platformer-with-tilemap))",
    "* Align top-down characters on a grid ([open the project online](https://editor.gdevelop.io/?project=example://top-down-grid-movement))"
  ],
  "origin": {
    "identifier": "PixelPerfectMovement",
    "name": "gdevelop-extension-store"
  },
  "tags": [
    "pixel perfect",
    "platform",
    "top down",
    "movement",
    "grid"
  ],
  "authorIds": [
    "IWykYNRvhCZBN3vEgKEbBPOR3Oc2"
  ],
  "dependencies": [],
  "eventsFunctions": [
    {
      "description": "Return the speed necessary to cover a distance according to the deceleration.",
      "fullName": "Speed to reach",
      "functionType": "Expression",
      "name": "SpeedToReach",
      "private": true,
      "sentence": "Braking distance from an initial speed: _PARAM2_ and a deceleration: _PARAM3_ is less than _PARAM1_",
      "events": [
        {
          "type": "BuiltinCommonInstructions::Standard",
          "conditions": [
            {
              "type": {
                "value": "BuiltinCommonInstructions::CompareNumbers"
              },
              "parameters": [
                "GetArgumentAsNumber(\"Distance\")",
                ">=",
                "0"
              ]
            }
          ],
          "actions": [
            {
              "type": {
                "value": "SetReturnNumber"
              },
              "parameters": [
                "sqrt(2 * GetArgumentAsNumber(\"Distance\") * GetArgumentAsNumber(\"Deceleration\"))"
              ]
            }
          ]
        },
        {
          "type": "BuiltinCommonInstructions::Standard",
          "conditions": [
            {
              "type": {
                "value": "BuiltinCommonInstructions::CompareNumbers"
              },
              "parameters": [
                "GetArgumentAsNumber(\"Distance\")",
                "<",
                "0"
              ]
            }
          ],
          "actions": [
            {
              "type": {
                "value": "SetReturnNumber"
              },
              "parameters": [
                "-sqrt(-2 * GetArgumentAsNumber(\"Distance\") * GetArgumentAsNumber(\"Deceleration\"))"
              ]
            }
          ]
        }
      ],
      "expressionType": {
        "type": "expression"
      },
      "parameters": [
        {
          "description": "Distance",
          "name": "Distance",
          "type": "expression"
        },
        {
          "description": "Deceleration",
          "name": "Deceleration",
          "type": "expression"
        }
      ],
      "objectGroups": []
    },
    {
      "description": "Return the braking distance according to an initial speed and a deceleration.",
      "fullName": "Braking distance",
      "functionType": "Expression",
      "name": "BrakingDistance",
      "private": true,
      "sentence": "Braking distance from an initial speed: _PARAM2_ and a deceleration: _PARAM3_ is less than _PARAM1_",
      "events": [
        {
          "type": "BuiltinCommonInstructions::Standard",
          "conditions": [],
          "actions": [
            {
              "type": {
                "value": "SetReturnNumber"
              },
              "parameters": [
                "GetArgumentAsNumber(\"Speed\") * GetArgumentAsNumber(\"Speed\") / (2 * GetArgumentAsNumber(\"Deceleration\"))"
              ]
            }
          ]
        }
      ],
      "expressionType": {
        "type": "expression"
      },
      "parameters": [
        {
          "description": "Speed",
          "name": "Speed",
          "type": "expression"
        },
        {
          "description": "Deceleration",
          "name": "Deceleration",
          "type": "expression"
        }
      ],
      "objectGroups": []
    },
    {
      "description": "Define JavaScript classes for top-down.",
      "fullName": "Define JavaScript classes for top-down",
      "functionType": "Action",
      "name": "DefineJavaScriptForTopDown",
      "private": true,
      "sentence": "Define JavaScript classes  for top-down",
      "events": [
        {
          "type": "BuiltinCommonInstructions::Standard",
          "conditions": [
            {
              "type": {
                "value": "GlobalVariableAsBoolean"
              },
              "parameters": [
                "__pixelPerfect.TopDownClassesDefined",
                ""
              ]
            }
          ],
          "actions": [
            {
              "type": {
                "value": "SetGlobalVariableAsBoolean"
              },
              "parameters": [
                "__pixelPerfect.TopDownClassesDefined",
                "True"
              ]
            }
          ],
          "events": [
            {
              "type": "BuiltinCommonInstructions::JsCode",
              "inlineCode": [
                "gdjs.__pixelPerfectExtension = gdjs.__pixelPerfectExtension || {};",
                "",
                "gdjs.__pixelPerfectExtension.PixelPerfectTopDownMovement =  /** @class */ (function () {",
                "",
                "  /**",
                "   * @param behavior {gdjs.RuntimeBehavior}",
                "   * @param behavior {gdjs.TopDownMovementRuntimeBehavior}",
                "   */",
                "  function PixelPerfectTopDownMovement(pixelPerfectBehavior, topDownBehavior) {",
                "    /** @type {gdjs.RuntimeBehavior} */",
                "    this.pixelPerfectBehavior = pixelPerfectBehavior;",
                "    /** @type {gdjs.TopDownMovementRuntimeBehavior} */",
                "    this.topDownBehavior = topDownBehavior;",
                "",
                "    /** @type {number | null} */",
                "    this.targetX = null;",
                "    /** @type {number | null} */",
                "    this.targetY = null;",
                "    this.targetDirectionX = 0;",
                "    this.targetDirectionY = 0;",
                "    this.lastDirection = -1;",
                "  }",
                "",
                "  /**",
                "   * @param instanceContainer {gdjs.RuntimeInstanceContainer}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.doStepPreEvents = function (instanceContainer) {",
                "    if (!this.pixelPerfectBehavior.activated()) {",
                "      this.topDownBehavior.doStepPreEventsNotPixelPerfect(instanceContainer);",
                "      return;",
                "    }",
                "",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetX = this.pixelPerfectBehavior._getOffsetX();",
                "    /** @type {number} */",
                "    const gridOffsetY = this.pixelPerfectBehavior._getOffsetY();",
                "    const that = this.topDownBehavior;",
                "    const object = that.owner;",
                "    const timeDelta = object.getElapsedTime() / 1000;",
                "",
                "    const LEFTKEY = 37;",
                "    const UPKEY = 38;",
                "    const RIGHTKEY = 39;",
                "    const DOWNKEY = 40;",
                "",
                "    //Get the player input:",
                "    // @ts-ignore",
                "    that._leftKey |=",
                "      !that._ignoreDefaultControls &&",
                "      instanceContainer.getGame().getInputManager().isKeyPressed(LEFTKEY);",
                "    // @ts-ignore",
                "    that._rightKey |=",
                "      !that._ignoreDefaultControls &&",
                "      instanceContainer.getGame().getInputManager().isKeyPressed(RIGHTKEY);",
                "    // @ts-ignore",
                "    that._downKey |=",
                "      !that._ignoreDefaultControls &&",
                "      instanceContainer.getGame().getInputManager().isKeyPressed(DOWNKEY);",
                "    // @ts-ignore",
                "    that._upKey |=",
                "      !that._ignoreDefaultControls &&",
                "      instanceContainer.getGame().getInputManager().isKeyPressed(UPKEY);",
                "",
                "    const elapsedTime = that.owner.getElapsedTime();",
                "",
                "    if (!that._leftKey) {",
                "      that._leftKeyPressedDuration = 0;",
                "    } else {",
                "      that._leftKeyPressedDuration += elapsedTime;",
                "    }",
                "    if (!that._rightKey) {",
                "      that._rightKeyPressedDuration = 0;",
                "    } else {",
                "      that._rightKeyPressedDuration += elapsedTime;",
                "    }",
                "    if (!that._downKey) {",
                "      that._downKeyPressedDuration = 0;",
                "    } else {",
                "      that._downKeyPressedDuration += elapsedTime;",
                "    }",
                "    if (!that._upKey) {",
                "      that._upKeyPressedDuration = 0;",
                "    } else {",
                "      that._upKeyPressedDuration += elapsedTime;",
                "    }",
                "",
                "    let direction = -1;",
                "    if (!that._allowDiagonals) {",
                "      if (that._upKey && !that._downKey) {",
                "        direction = 6;",
                "      } else if (!that._upKey && that._downKey) {",
                "        direction = 2;",
                "      }",
                "      // when 2 keys are pressed for diagonals the most recently pressed win",
                "      if (",
                "        that._leftKey &&",
                "        !that._rightKey &&",
                "        (that._upKey === that._downKey ||",
                "          (that._upKey &&",
                "            that._leftKeyPressedDuration < that._upKeyPressedDuration) ||",
                "          (that._downKey &&",
                "            that._leftKeyPressedDuration < that._downKeyPressedDuration))",
                "      ) {",
                "        direction = 4;",
                "      } else if (",
                "        that._rightKey &&",
                "        !that._leftKey &&",
                "        (that._upKey === that._downKey ||",
                "          (that._upKey &&",
                "            that._rightKeyPressedDuration < that._upKeyPressedDuration) ||",
                "          (that._downKey &&",
                "            that._rightKeyPressedDuration < that._downKeyPressedDuration))",
                "      ) {",
                "        direction = 0;",
                "      }",
                "",
                "      if (cellSize > 0) {",
                "        // Forbid to turn before being aligned on the grid.",
                "",
                "        const deltaX = Math.abs(that._xVelocity * timeDelta);",
                "        const deltaY = Math.abs(that._yVelocity * timeDelta);",
                "",
                "        const isTryingToMoveOnX = direction === 4 || direction === 0;",
                "        const isTryingToMoveOnY = direction === 6 || direction === 2;",
                "        if (isTryingToMoveOnX) {",
                "          if (that._yVelocity < 0) {",
                "            if (Math.abs(this.ceilToCellY(object.y) - object.y) > deltaY) {",
                "              direction = 6;",
                "            } else {",
                "              object.y = this.ceilToCellY(object.y);",
                "            }",
                "          }",
                "          if (that._yVelocity > 0) {",
                "            if (Math.abs(this.floorToCellY(object.y) - object.y) > deltaY) {",
                "              direction = 2;",
                "            } else {",
                "              object.y = this.floorToCellY(object.y);",
                "            }",
                "          }",
                "        } else if (isTryingToMoveOnY) {",
                "          if (that._xVelocity < 0) {",
                "            if (Math.abs(this.ceilToCellX(object.x) - object.x) > deltaX) {",
                "              direction = 4;",
                "            } else {",
                "              object.x = this.ceilToCellX(object.x);",
                "            }",
                "          }",
                "          if (that._xVelocity > 0) {",
                "            if (Math.abs(this.floorToCellX(object.x) - object.x) > deltaX) {",
                "              direction = 0;",
                "            } else {",
                "              object.x = this.floorToCellX(object.x);",
                "            }",
                "          }",
                "        }",
                "",
                "        // Ensure sharp turn even with Verlet integrations.",
                "        const speed = Math.abs(that._xVelocity + that._yVelocity);",
                "        if (direction === 0) {",
                "          that._xVelocity = speed;",
                "          that._yVelocity = 0;",
                "        } else if (direction === 4) {",
                "          that._xVelocity = -speed;",
                "          that._yVelocity = 0;",
                "        } else if (direction === 2) {",
                "          that._yVelocity = speed;",
                "          that._xVelocity = 0;",
                "        } else if (direction === 6) {",
                "          that._yVelocity = -speed;",
                "          that._xVelocity = 0;",
                "        }",
                "      }",
                "    } else {",
                "      if (that._upKey && !that._downKey) {",
                "        if (that._leftKey && !that._rightKey) {",
                "          direction = 5;",
                "        } else if (!that._leftKey && that._rightKey) {",
                "          direction = 7;",
                "        } else {",
                "          direction = 6;",
                "        }",
                "      } else if (!that._upKey && that._downKey) {",
                "        if (that._leftKey && !that._rightKey) {",
                "          direction = 3;",
                "        } else if (!that._leftKey && that._rightKey) {",
                "          direction = 1;",
                "        } else {",
                "          direction = 2;",
                "        }",
                "      } else {",
                "        if (that._leftKey && !that._rightKey) {",
                "          direction = 4;",
                "        } else if (!that._leftKey && that._rightKey) {",
                "          direction = 0;",
                "        }",
                "      }",
                "    }",
                "",
                "    if (cellSize > 0) {",
                "      const isMovingOnX =",
                "        direction !== -1 && direction !== 2 && direction !== 6;",
                "      if (isMovingOnX) {",
                "        this.targetX = null;",
                "      } else if (this.targetX === null) {",
                "        // Find where the deceleration should stop the object.",
                "        if (that._xVelocity > 0) {",
                "          this.targetX = this.ceilToCellX(",
                "            object.x + this.getBreakingDistanceX()",
                "          );",
                "          this.targetDirectionX = 1;",
                "        }",
                "        if (that._xVelocity < 0) {",
                "          this.targetX = this.floorToCellX(",
                "            object.x - this.getBreakingDistanceX()",
                "          );",
                "          this.targetDirectionX = -1;",
                "        }",
                "      }",
                "",
                "      const isMovingOnY =",
                "        direction !== -1 && direction !== 0 && direction !== 4;",
                "      if (isMovingOnY) {",
                "        this.targetY = null;",
                "      } else if (this.targetY === null) {",
                "        // Find where the deceleration should stop the object.",
                "        if (that._yVelocity > 0) {",
                "          this.targetY = this.ceilToCellY(",
                "            object.y + this.getBreakingDistanceY()",
                "          );",
                "          this.targetDirectionY = 1;",
                "        }",
                "        if (that._yVelocity < 0) {",
                "          this.targetY = this.floorToCellY(",
                "            object.y - this.getBreakingDistanceY()",
                "          );",
                "          this.targetDirectionY = -1;",
                "        }",
                "      }",
                "    }",
                "",
                "    let previousVelocityX = that._xVelocity;",
                "    let previousVelocityY = that._yVelocity;",
                "    that._wasStickUsed = false;",
                "",
                "    // These 4 values are not actually used.",
                "    // JavaScript doesn't allow to declare",
                "    // variables without assigning them a value.",
                "    let directionInRad = 0;",
                "    let directionInDeg = 0;",
                "    let cos = 1;",
                "    let sin = 0;",
                "",
                "    // Update the speed of the object:",
                "    if (direction !== -1) {",
                "      directionInRad =",
                "        ((direction + that._movementAngleOffset / 45) * Math.PI) / 4.0;",
                "      directionInDeg = direction * 45 + that._movementAngleOffset;",
                "      // This makes the trigo resilient to rounding errors on directionInRad.",
                "      cos = Math.cos(directionInRad);",
                "      sin = Math.sin(directionInRad);",
                "      if (cos === -1 || cos === 1) {",
                "        sin = 0;",
                "      }",
                "      if (sin === -1 || sin === 1) {",
                "        cos = 0;",
                "      }",
                "      that._xVelocity += that._acceleration * timeDelta * cos;",
                "      that._yVelocity += that._acceleration * timeDelta * sin;",
                "    } else if (that._stickForce !== 0) {",
                "      if (!that._allowDiagonals) {",
                "        that._stickAngle = 90 * Math.floor((that._stickAngle + 45) / 90);",
                "      }",
                "      directionInDeg = that._stickAngle + that._movementAngleOffset;",
                "      directionInRad = (directionInDeg * Math.PI) / 180;",
                "      const norm = that._acceleration * timeDelta * that._stickForce;",
                "      // This makes the trigo resilient to rounding errors on directionInRad.",
                "      cos = Math.cos(directionInRad);",
                "      sin = Math.sin(directionInRad);",
                "      if (cos === -1 || cos === 1) {",
                "        sin = 0;",
                "      }",
                "      if (sin === -1 || sin === 1) {",
                "        cos = 0;",
                "      }",
                "      that._xVelocity += norm * cos;",
                "      that._yVelocity += norm * sin;",
                "",
                "      that._wasStickUsed = true;",
                "      that._stickForce = 0;",
                "    } else if (that._yVelocity !== 0 || that._xVelocity !== 0) {",
                "      directionInRad = Math.atan2(that._yVelocity, that._xVelocity);",
                "      directionInDeg = (directionInRad * 180.0) / Math.PI;",
                "      const xVelocityWasPositive = that._xVelocity >= 0;",
                "      const yVelocityWasPositive = that._yVelocity >= 0;",
                "      // This makes the trigo resilient to rounding errors on directionInRad.",
                "      cos = Math.cos(directionInRad);",
                "      sin = Math.sin(directionInRad);",
                "      if (cos === -1 || cos === 1) {",
                "        sin = 0;",
                "      }",
                "      if (sin === -1 || sin === 1) {",
                "        cos = 0;",
                "      }",
                "      that._xVelocity -= that._deceleration * timeDelta * cos;",
                "      that._yVelocity -= that._deceleration * timeDelta * sin;",
                "      if (that._xVelocity > 0 !== xVelocityWasPositive) {",
                "        that._xVelocity = 0;",
                "      }",
                "      if (that._yVelocity > 0 !== yVelocityWasPositive) {",
                "        that._yVelocity = 0;",
                "      }",
                "    }",
                "    const squaredSpeed =",
                "      that._xVelocity * that._xVelocity + that._yVelocity * that._yVelocity;",
                "    if (squaredSpeed > that._maxSpeed * that._maxSpeed) {",
                "      that._xVelocity = that._maxSpeed * cos;",
                "      that._yVelocity = that._maxSpeed * sin;",
                "    }",
                "",
                "    if (cellSize > 0) {",
                "      // Make as if the player had press button a bit longer to reach exactly",
                "      // the next cell.",
                "",
                "      if (this.targetX !== null) {",
                "        if (this.targetX > object.x) {",
                "          if (this.targetDirectionX > 0) {",
                "            that._xVelocity = Math.min(",
                "              that._xVelocity + that._acceleration,",
                "              that._maxSpeed,",
                "              this.getSpeedToReach(this.targetX - object.x)",
                "            );",
                "          } else {",
                "            that._xVelocity = 0;",
                "            object.x = this.roundToCellX(object.x);",
                "            this.targetX = null;",
                "          }",
                "        } else {",
                "          if (this.targetDirectionX < 0) {",
                "            that._xVelocity = Math.max(",
                "              that._xVelocity - that._acceleration,",
                "              -that._maxSpeed,",
                "              this.getSpeedToReach(this.targetX - object.x)",
                "            );",
                "          } else {",
                "            that._xVelocity = 0;",
                "            object.x = this.roundToCellX(object.x);",
                "            this.targetX = null;",
                "          }",
                "        }",
                "        // The velocity is exact. There no need for Verlet integration.",
                "        previousVelocityX = that._xVelocity;",
                "      }",
                "",
                "      if (this.targetY !== null) {",
                "        if (this.targetY > object.y) {",
                "          if (this.targetDirectionY > 0) {",
                "            that._yVelocity = Math.min(",
                "              that._yVelocity + that._acceleration,",
                "              that._maxSpeed,",
                "              this.getSpeedToReach(this.targetY - object.y)",
                "            );",
                "          } else {",
                "            that._yVelocity = 0;",
                "            object.y = this.roundToCellY(object.y);",
                "            this.targetY = null;",
                "          }",
                "        } else {",
                "          if (this.targetDirectionY < 0) {",
                "            that._yVelocity = Math.max(",
                "              that._yVelocity - that._acceleration,",
                "              -that._maxSpeed,",
                "              this.getSpeedToReach(this.targetY - object.y)",
                "            );",
                "          } else {",
                "            that._yVelocity = 0;",
                "            object.y = this.roundToCellY(object.y);",
                "            this.targetY = null;",
                "          }",
                "        }",
                "        // The velocity is exact. There no need for Verlet integration.",
                "        previousVelocityY = that._yVelocity;",
                "      }",
                "    }",
                "",
                "    // No acceleration for angular speed for now.",
                "    that._angularSpeed = that._angularMaxSpeed;",
                "",
                "    // Position object.",
                "    // This is a Verlet integration considering the acceleration as constant.",
                "    // If you expand deltaX or deltaY, it gives, thanks to the usage of both",
                "    // the old and the new velocity:",
                "    // \"velocity * timeDelta + acceleration * timeDelta^2 / 2\".",
                "    //",
                "    // The acceleration is not actually always constant, particularly with a gamepad,",
                "    // but the error is multiplied by timDelta^3. So, it shouldn't matter much.",
                "    const deltaX = ((previousVelocityX + that._xVelocity) / 2) * timeDelta;",
                "    const deltaY = ((previousVelocityY + that._yVelocity) / 2) * timeDelta;",
                "    if (that._basisTransformation === null) {",
                "      // Top-down viewpoint",
                "      object.setX(object.getX() + deltaX);",
                "      object.setY(object.getY() + deltaY);",
                "    } else {",
                "      // Isometry viewpoint",
                "      const point = that._temporaryPointForTransformations;",
                "      point[0] = deltaX;",
                "      point[1] = deltaY;",
                "      that._basisTransformation.toScreen(point, point);",
                "      object.setX(object.getX() + point[0]);",
                "      object.setY(object.getY() + point[1]);",
                "    }",
                "",
                "    // Also update angle if needed.",
                "    if (that._xVelocity !== 0 || that._yVelocity !== 0) {",
                "      that._angle = directionInDeg;",
                "      if (that._rotateObject) {",
                "        object.rotateTowardAngle(",
                "          directionInDeg + that._angleOffset,",
                "          that._angularSpeed",
                "        );",
                "      }",
                "    }",
                "",
                "    this.lastDirection = direction;",
                "    that._leftKey = false;",
                "    that._rightKey = false;",
                "    that._upKey = false;",
                "    that._downKey = false;",
                "  }",
                "",
                "  const epsilon = 1 / (1 << 20);",
                "",
                "  PixelPerfectTopDownMovement.prototype.doStepPostEvents = function (instanceContainer) {",
                "    const that = this.topDownBehavior;",
                "    const object = that.owner;",
                "",
                "    const isMovingOnX =",
                "      this.lastDirection !== -1 &&",
                "      this.lastDirection !== 2 &&",
                "      this.lastDirection !== 6;",
                "    const isMovingOnY =",
                "      this.lastDirection !== -1 &&",
                "      this.lastDirection !== 0 &&",
                "      this.lastDirection !== 4;",
                "",
                "",
                "    // Avoid rounding errors after a call to \"separate\" to make characters",
                "    // move indefinitely in front of a wall because they can't reach the cell.",
                "    if (!isMovingOnX && that._xVelocity !== 0) {",
                "      const x = object.getX();",
                "      const roundedX = this.roundToCellX(x);",
                "      if (Math.abs(roundedX - x) < epsilon) {",
                "        object.setX(roundedX);",
                "        this.targetDirectionX = 0;",
                "        that._xVelocity = 0;",
                "      }",
                "    }",
                "    if (!isMovingOnY && that._yVelocity !== 0) {",
                "      const y = object.getY();",
                "      const roundedY = this.roundToCellY(y);",
                "      if (Math.abs(roundedY - y) < epsilon) {",
                "        object.setY(roundedY);",
                "        this.targetDirectionY = 0;",
                "        that._yVelocity = 0;",
                "      }",
                "    }",
                "  }",
                "",
                "  /**",
                "   * @returns {number} the braking distance according to an initial speed and a deceleration.",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.getBreakingDistanceX = function () {",
                "    const that = this.topDownBehavior;",
                "    return (that._xVelocity * that._xVelocity) / (2 * that._deceleration);",
                "  }",
                "",
                "  /**",
                "   * @returns {number} the braking distance according to an initial speed and a deceleration.",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.getBreakingDistanceY = function () {",
                "    const that = this.topDownBehavior;",
                "    return (that._yVelocity * that._yVelocity) / (2 * that._deceleration);",
                "  }",
                "",
                "  /**",
                "   * @param {number} displacement",
                "   * @returns {number} the speed necessary to cover a distance according to the deceleration.",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.getSpeedToReach = function (displacement) {",
                "    const that = this.topDownBehavior;",
                "    return (",
                "      Math.sign(displacement) *",
                "      Math.sqrt(2 * Math.abs(displacement) * that._deceleration)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} x",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.ceilToCellX = function (x) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetX = this.pixelPerfectBehavior._getOffsetX();",
                "",
                "    return (",
                "      gridOffsetX +",
                "      cellSize * Math.ceil((x - gridOffsetX) / cellSize)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} x",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.roundToCellX = function (x) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetX = this.pixelPerfectBehavior._getOffsetX();",
                "",
                "    return (",
                "      gridOffsetX +",
                "      cellSize * Math.round((x - gridOffsetX) / cellSize)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} x",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.floorToCellX = function (x) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetX = this.pixelPerfectBehavior._getOffsetX();",
                "",
                "    return (",
                "      gridOffsetX +",
                "      cellSize * Math.floor((x - gridOffsetX) / cellSize)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} y",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.ceilToCellY = function (y) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetY = this.pixelPerfectBehavior._getOffsetY();",
                "",
                "    return (",
                "      gridOffsetY +",
                "      cellSize * Math.ceil((y - gridOffsetY) / cellSize)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} y",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.roundToCellY = function (y) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetY = this.pixelPerfectBehavior._getOffsetY();",
                "",
                "    return (",
                "      gridOffsetY +",
                "      cellSize * Math.round((y - gridOffsetY) / cellSize)",
                "    );",
                "  }",
                "",
                "  /**",
                "   * @param {number} y",
                "   * @return {number}",
                "   */",
                "  PixelPerfectTopDownMovement.prototype.floorToCellY = function (y) {",
                "    /** @type {number} */",
                "    const cellSize = this.pixelPerfectBehavior._getPixelSize();",
                "    /** @type {number} */",
                "    const gridOffsetY = this.pixelPerfectBehavior._getOffsetY();",
                "",
                "    return (",
                "      gridOffsetY +",
                "      cellSize * Math.floor((y - gridOffsetY) / cellSize)",
                "    );",
                "  }",
                "",
                "  return PixelPerfectTopDownMovement;",
                "}());",
                "",
                ""
              ],
              "parameterObjects": "",
              "useStrict": true,
              "eventsSheetExpanded": true
            }
          ]
        }
      ],
      "parameters": [],
      "objectGroups": []
    }
  ],
  "eventsBasedBehaviors": [
    {
      "description": "Seamlessly align big pixels using a top-down movement.",
      "fullName": "Pixel perfect top-down movement",
      "name": "PixelPerfectTopDownMovement",
      "objectType": "",
      "eventsFunctions": [
        {
          "fullName": "",
          "functionType": "Action",
          "name": "onCreated",
          "sentence": "",
          "events": [
            {
              "type": "BuiltinCommonInstructions::Standard",
              "conditions": [],
              "actions": [
                {
                  "type": {
                    "value": "PixelPerfectMovement::DefineJavaScriptForTopDown"
                  },
                  "parameters": [
                    "",
                    ""
                  ]
                }
              ]
            },
            {
              "type": "BuiltinCommonInstructions::JsCode",
              "inlineCode": [
                "\r",
                "const object = objects[0];\r",
                "const behaviorName = eventsFunctionContext.getBehaviorName(\"Behavior\");\r",
                "const behavior = object.getBehavior(behaviorName);\r",
                "\r",
                "/** @type {gdjs.TopDownMovementRuntimeBehavior} */\r",
                "const topDownBehavior = object.getBehavior(behavior._getTopDownMovement());\r",
                "\r",
                "const pixelPerfect = new gdjs.__pixelPerfectExtension.PixelPerfectTopDownMovement(behavior, topDownBehavior);\r",
                "topDownBehavior.__pixelPerfect = pixelPerfect;\r",
                "behavior.__pixelPerfect = pixelPerfect;\r",
                "\r",
                "// Copy the classic top-down implementation to call it\r",
                "// when the pixel-perfect behavior is deactivated.\r",
                "gdjs.TopDownMovementRuntimeBehavior.prototype.doStepPreEventsNotPixelPerfect =\r",
                "    gdjs.TopDownMovementRuntimeBehavior.prototype.doStepPreEvents;\r",
                "\r",
                "// Bypass the top-down movement implementation to use the pixel perfect one.\r",
                "topDownBehavior.doStepPreEvents = function(instanceContainer) {\r",
                "    this.__pixelPerfect.doStepPreEvents(instanceContainer);\r",
                "}\r",
                ""
              ],
              "parameterObjects": "Object",
              "useStrict": true,
              "eventsSheetExpanded": true
            }
          ],
          "parameters": [
            {
              "description": "Object",
              "name": "Object",
              "type": "object"
            },
            {
              "description": "Behavior",
              "name": "Behavior",
              "supplementaryInformation": "PixelPerfectMovement::PixelPerfectTopDownMovement",
              "type": "behavior"
            }
          ],
          "objectGroups": []
        },
        {
          "fullName": "",
          "functionType": "Action",
          "name": "doStepPostEvents",
          "sentence": "",
          "events": [
            {
              "type": "BuiltinCommonInstructions::JsCode",
              "inlineCode": [
                "const object = objects[0];",
                "const behaviorName = eventsFunctionContext.getBehaviorName(\"Behavior\");",
                "const behavior = object.getBehavior(behaviorName);",
                "",
                "behavior.__pixelPerfect.doStepPostEvents(runtimeScene);"
              ],
              "parameterObjects": "Object",
              "useStrict": true,
              "eventsSheetExpanded": true
            }
          ],
          "parameters": [
            {
              "description": "Object",
              "name": "Object",
              "type": "object"
            },
            {
              "description": "Behavior",
              "name": "Behavior",
              "supplementaryInformation": "PixelPerfectMovement::PixelPerfectTopDownMovement",
              "type": "behavior"
            }
          ],
          "objectGroups": []
        }
      ],
      "propertyDescriptors": [
        {
          "value": "",
          "type": "Behavior",
          "label": "Top-down movement behavior",
          "description": "",
          "group": "",
          "extraInformation": [
            "TopDownMovementBehavior::TopDownMovementBehavior"
          ],
          "hidden": false,
          "name": "TopDownMovement"
        },
        {
          "value": "1",
          "type": "Number",
          "label": "Pixel size",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "PixelSize"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "Pixel grid offset X",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "OffsetX"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "Pixel grid offset Y",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "OffsetY"
        }
      ],
      "sharedPropertyDescriptors": []
    },
    {
      "description": "Seamlessly align big pixels using a platformer character movement.",
      "fullName": "Pixel perfect platformer character",
      "name": "PixelPerfectPlatformerCharacter",
      "objectType": "",
      "eventsFunctions": [
        {
          "fullName": "",
          "functionType": "Action",
          "name": "doStepPreEvents",
          "sentence": "",
          "events": [
            {
              "colorB": 228,
              "colorG": 176,
              "colorR": 74,
              "creationTime": 0,
              "name": "X axis",
              "source": "",
              "type": "BuiltinCommonInstructions::Group",
              "events": [
                {
                  "type": "BuiltinCommonInstructions::Comment",
                  "color": {
                    "b": 109,
                    "g": 230,
                    "r": 255,
                    "textB": 0,
                    "textG": 0,
                    "textR": 0
                  },
                  "comment": "We don't know if the deceleration was already applied or not this step, but if the speed drifted from more than 1%, another extension is probably modifying the speed and it must not be overridden.",
                  "comment2": ""
                },
                {
                  "type": "BuiltinCommonInstructions::Standard",
                  "conditions": [
                    {
                      "type": {
                        "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyIsDecelerating"
                      },
                      "parameters": [
                        "Object",
                        "Behavior"
                      ]
                    },
                    {
                      "type": {
                        "value": "BuiltinCommonInstructions::CompareNumbers"
                      },
                      "parameters": [
                        "abs(Object.PlatformerCharacter::CurrentSpeed() - Object.Behavior::PropertyPreviousSpeedX())",
                        "<",
                        "Object.PlatformerCharacter::CurrentSpeed() * 0.01 + Object.PlatformerCharacter::Deceleration() * TimeDelta()"
                      ]
                    }
                  ],
                  "actions": [],
                  "events": [
                    {
                      "type": "BuiltinCommonInstructions::Comment",
                      "color": {
                        "b": 109,
                        "g": 230,
                        "r": 255,
                        "textB": 0,
                        "textG": 0,
                        "textR": 0
                      },
                      "comment": "Find how far to go to reach a pixel.",
                      "comment2": ""
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "value": "BuiltinCommonInstructions::Once"
                          },
                          "parameters": []
                        }
                      ],
                      "actions": [],
                      "events": [
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "value": "PlatformBehavior::CurrentSpeed"
                              },
                              "parameters": [
                                "Object",
                                "PlatformerCharacter",
                                ">",
                                "0"
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetX"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "Object.Behavior::PropertyOffsetX() + Object.Behavior::PropertyPixelSize() * ceil((Object.X() + PixelPerfectMovement::BrakingDistance(Object.PlatformerCharacter::CurrentSpeed(), Object.PlatformerCharacter::Deceleration()) - Object.Behavior::PropertyOffsetX()) / Object.Behavior::PropertyPixelSize())"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionX"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "1"
                              ]
                            }
                          ],
                          "events": [
                            {
                              "disabled": true,
                              "type": "BuiltinCommonInstructions::Standard",
                              "conditions": [],
                              "actions": [
                                {
                                  "type": {
                                    "value": "DebuggerTools::ConsoleLog"
                                  },
                                  "parameters": [
                                    "\"Target: \" + ToString(Object.X()) + \"-->\" + ToString(Object.Behavior::PropertyTargetX())",
                                    "",
                                    ""
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "value": "PlatformBehavior::CurrentSpeed"
                              },
                              "parameters": [
                                "Object",
                                "PlatformerCharacter",
                                "<",
                                "0"
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetX"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "Object.Behavior::PropertyOffsetX() + Object.Behavior::PropertyPixelSize() * floor((Object.X() - PixelPerfectMovement::BrakingDistance(Object.PlatformerCharacter::CurrentSpeed(), Object.PlatformerCharacter::Deceleration()) - Object.Behavior::PropertyOffsetX()) / Object.Behavior::PropertyPixelSize())"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionX"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "-1"
                              ]
                            }
                          ],
                          "events": [
                            {
                              "disabled": true,
                              "type": "BuiltinCommonInstructions::Standard",
                              "conditions": [],
                              "actions": [
                                {
                                  "type": {
                                    "value": "DebuggerTools::ConsoleLog"
                                  },
                                  "parameters": [
                                    "\"Target: \" + ToString(Object.X()) + \"-->\" + ToString(Object.Behavior::PropertyTargetX())",
                                    "",
                                    ""
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "BuiltinCommonInstructions::Comment",
                      "color": {
                        "b": 109,
                        "g": 230,
                        "r": 255,
                        "textB": 0,
                        "textG": 0,
                        "textR": 0
                      },
                      "comment": "Move to the target as the movement behavior would do.",
                      "comment2": ""
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "value": "PosX"
                          },
                          "parameters": [
                            "Object",
                            "<",
                            "Object.Behavior::PropertyTargetX()"
                          ]
                        },
                        {
                          "type": {
                            "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionX"
                          },
                          "parameters": [
                            "Object",
                            "Behavior",
                            "=",
                            "1"
                          ]
                        }
                      ],
                      "actions": [
                        {
                          "type": {
                            "value": "PlatformBehavior::PlatformerObjectBehavior::SetCurrentSpeed"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "=",
                            "min(Object.PlatformerCharacter:: CurrentSpeed() + Object.PlatformerCharacter::Acceleration(), min(Object.PlatformerCharacter::MaxSpeed(), PixelPerfectMovement::SpeedToReach(Object.Behavior::PropertyTargetX() - Object.X(), Object.PlatformerCharacter::Deceleration())))"
                          ]
                        }
                      ]
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "value": "PosX"
                          },
                          "parameters": [
                            "Object",
                            ">",
                            "Object.Behavior::PropertyTargetX()"
                          ]
                        },
                        {
                          "type": {
                            "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionX"
                          },
                          "parameters": [
                            "Object",
                            "Behavior",
                            "=",
                            "-1"
                          ]
                        }
                      ],
                      "actions": [
                        {
                          "type": {
                            "value": "PlatformBehavior::PlatformerObjectBehavior::SetCurrentSpeed"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "=",
                            "max(Object.PlatformerCharacter:: CurrentSpeed() - Object.PlatformerCharacter::Acceleration(), max(-Object.PlatformerCharacter::MaxSpeed(), PixelPerfectMovement::SpeedToReach(Object.Behavior::PropertyTargetX() - Object.X(), Object.PlatformerCharacter::Deceleration())))"
                          ]
                        }
                      ]
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "value": "BuiltinCommonInstructions::Or"
                          },
                          "parameters": [],
                          "subInstructions": [
                            {
                              "type": {
                                "value": "BuiltinCommonInstructions::And"
                              },
                              "parameters": [],
                              "subInstructions": [
                                {
                                  "type": {
                                    "value": "PosX"
                                  },
                                  "parameters": [
                                    "Object",
                                    ">=",
                                    "Object.Behavior::PropertyTargetX()"
                                  ]
                                },
                                {
                                  "type": {
                                    "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionX"
                                  },
                                  "parameters": [
                                    "Object",
                                    "Behavior",
                                    "=",
                                    "1"
                                  ]
                                }
                              ]
                            },
                            {
                              "type": {
                                "value": "BuiltinCommonInstructions::And"
                              },
                              "parameters": [],
                              "subInstructions": [
                                {
                                  "type": {
                                    "value": "PosX"
                                  },
                                  "parameters": [
                                    "Object",
                                    "<=",
                                    "Object.Behavior::PropertyTargetX()"
                                  ]
                                },
                                {
                                  "type": {
                                    "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionX"
                                  },
                                  "parameters": [
                                    "Object",
                                    "Behavior",
                                    "=",
                                    "-1"
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ],
                      "actions": [
                        {
                          "type": {
                            "value": "MettreX"
                          },
                          "parameters": [
                            "Object",
                            "=",
                            "Object.Behavior::PropertyOffsetX() + Object.Behavior::PropertyPixelSize() * round((Object.X() - Object.Behavior::PropertyOffsetX()) / Object.Behavior::PropertyPixelSize())"
                          ]
                        },
                        {
                          "type": {
                            "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionX"
                          },
                          "parameters": [
                            "Object",
                            "Behavior",
                            "=",
                            "0"
                          ]
                        },
                        {
                          "type": {
                            "value": "PlatformBehavior::PlatformerObjectBehavior::SetCurrentSpeed"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "=",
                            "0"
                          ]
                        }
                      ],
                      "events": [
                        {
                          "disabled": true,
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [],
                          "actions": [
                            {
                              "type": {
                                "value": "DebuggerTools::ConsoleLog"
                              },
                              "parameters": [
                                "\"X: \" + ToString(Object.X()) + \" Speed: \" + ToString(Object.PlatformerCharacter::CurrentSpeed())",
                                "",
                                ""
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "parameters": []
            },
            {
              "colorB": 228,
              "colorG": 176,
              "colorR": 74,
              "creationTime": 0,
              "name": "Ladder",
              "source": "",
              "type": "BuiltinCommonInstructions::Group",
              "events": [
                {
                  "type": "BuiltinCommonInstructions::Standard",
                  "conditions": [
                    {
                      "type": {
                        "value": "PlatformBehavior::IsOnLadder"
                      },
                      "parameters": [
                        "Object",
                        "PlatformerCharacter"
                      ]
                    }
                  ],
                  "actions": [],
                  "events": [
                    {
                      "type": "BuiltinCommonInstructions::Comment",
                      "color": {
                        "b": 109,
                        "g": 230,
                        "r": 255,
                        "textB": 0,
                        "textG": 0,
                        "textR": 0
                      },
                      "comment": "Find how far to go to reach a pixel.",
                      "comment2": ""
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "inverted": true,
                            "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "\"Down\""
                          ]
                        },
                        {
                          "type": {
                            "value": "BuiltinCommonInstructions::Once"
                          },
                          "parameters": []
                        }
                      ],
                      "actions": [],
                      "events": [
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "inverted": true,
                                "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                              },
                              "parameters": [
                                "Object",
                                "PlatformerCharacter",
                                "\"Up\""
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "Object.Behavior::PropertyOffsetY() + Object.Behavior::PropertyPixelSize() * ceil((Object.Y() - Object.Behavior::PropertyOffsetY()) / Object.Behavior::PropertyPixelSize())"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "1"
                              ]
                            }
                          ],
                          "events": [
                            {
                              "disabled": true,
                              "type": "BuiltinCommonInstructions::Standard",
                              "conditions": [],
                              "actions": [
                                {
                                  "type": {
                                    "value": "DebuggerTools::ConsoleLog"
                                  },
                                  "parameters": [
                                    "\"Target: \" + ToString(Object.Y()) + \"-->\" + ToString(Object.Behavior::PropertyTargetY())",
                                    "",
                                    ""
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "inverted": true,
                            "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "\"Up\""
                          ]
                        },
                        {
                          "type": {
                            "value": "BuiltinCommonInstructions::Once"
                          },
                          "parameters": []
                        }
                      ],
                      "actions": [],
                      "events": [
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "inverted": true,
                                "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                              },
                              "parameters": [
                                "Object",
                                "PlatformerCharacter",
                                "\"Down\""
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "Object.Behavior::PropertyOffsetY() + Object.Behavior::PropertyPixelSize() * floor((Object.Y() - Object.Behavior::PropertyOffsetY()) / Object.Behavior::PropertyPixelSize())"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "-1"
                              ]
                            }
                          ],
                          "events": [
                            {
                              "disabled": true,
                              "type": "BuiltinCommonInstructions::Standard",
                              "conditions": [],
                              "actions": [
                                {
                                  "type": {
                                    "value": "DebuggerTools::ConsoleLog"
                                  },
                                  "parameters": [
                                    "\"Target: \" + ToString(Object.Y()) + \"-->\" + ToString(Object.Behavior::PropertyTargetY())",
                                    "",
                                    ""
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "BuiltinCommonInstructions::Comment",
                      "color": {
                        "b": 109,
                        "g": 230,
                        "r": 255,
                        "textB": 0,
                        "textG": 0,
                        "textR": 0
                      },
                      "comment": "Move to the target as the movement behavior would do.",
                      "comment2": ""
                    },
                    {
                      "type": "BuiltinCommonInstructions::Standard",
                      "conditions": [
                        {
                          "type": {
                            "inverted": true,
                            "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "\"Up\""
                          ]
                        },
                        {
                          "type": {
                            "inverted": true,
                            "value": "PlatformBehavior::PlatformerObjectBehavior::IsUsingControl"
                          },
                          "parameters": [
                            "Object",
                            "PlatformerCharacter",
                            "\"Down\""
                          ]
                        }
                      ],
                      "actions": [],
                      "events": [
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "value": "PosY"
                              },
                              "parameters": [
                                "Object",
                                "<",
                                "Object.Behavior::PropertyTargetY()"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "1"
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "MettreY"
                              },
                              "parameters": [
                                "Object",
                                "+",
                                "Object.PlatformerCharacter::MaxSpeed() * TimeDelta()"
                              ]
                            }
                          ]
                        },
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "value": "PosY"
                              },
                              "parameters": [
                                "Object",
                                ">",
                                "Object.Behavior::PropertyTargetY()"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "-1"
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "MettreY"
                              },
                              "parameters": [
                                "Object",
                                "-",
                                "Object.PlatformerCharacter::MaxSpeed() * TimeDelta()"
                              ]
                            }
                          ]
                        },
                        {
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [
                            {
                              "type": {
                                "value": "BuiltinCommonInstructions::Or"
                              },
                              "parameters": [],
                              "subInstructions": [
                                {
                                  "type": {
                                    "value": "BuiltinCommonInstructions::And"
                                  },
                                  "parameters": [],
                                  "subInstructions": [
                                    {
                                      "type": {
                                        "value": "PosY"
                                      },
                                      "parameters": [
                                        "Object",
                                        ">=",
                                        "Object.Behavior::PropertyTargetY()"
                                      ]
                                    },
                                    {
                                      "type": {
                                        "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionY"
                                      },
                                      "parameters": [
                                        "Object",
                                        "Behavior",
                                        "=",
                                        "1"
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "type": {
                                    "value": "BuiltinCommonInstructions::And"
                                  },
                                  "parameters": [],
                                  "subInstructions": [
                                    {
                                      "type": {
                                        "value": "PosY"
                                      },
                                      "parameters": [
                                        "Object",
                                        "<=",
                                        "Object.Behavior::PropertyTargetY()"
                                      ]
                                    },
                                    {
                                      "type": {
                                        "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::PropertyTargetDirectionY"
                                      },
                                      "parameters": [
                                        "Object",
                                        "Behavior",
                                        "=",
                                        "-1"
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ],
                          "actions": [
                            {
                              "type": {
                                "value": "MettreY"
                              },
                              "parameters": [
                                "Object",
                                "=",
                                "Object.Behavior::PropertyOffsetY() + Object.Behavior::PropertyPixelSize() * round((Object.Y() - Object.Behavior::PropertyOffsetY()) / Object.Behavior::PropertyPixelSize())"
                              ]
                            },
                            {
                              "type": {
                                "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyTargetDirectionY"
                              },
                              "parameters": [
                                "Object",
                                "Behavior",
                                "=",
                                "0"
                              ]
                            }
                          ]
                        },
                        {
                          "disabled": true,
                          "type": "BuiltinCommonInstructions::Standard",
                          "conditions": [],
                          "actions": [
                            {
                              "type": {
                                "value": "DebuggerTools::ConsoleLog"
                              },
                              "parameters": [
                                "\"X: \" + ToString(Object.X()) + \" Speed: \" + ToString(Object.PlatformerCharacter::CurrentSpeed())",
                                "",
                                ""
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "parameters": []
            }
          ],
          "parameters": [
            {
              "description": "Object",
              "name": "Object",
              "type": "object"
            },
            {
              "description": "Behavior",
              "name": "Behavior",
              "supplementaryInformation": "PixelPerfectMovement::PixelPerfectPlatformerCharacter",
              "type": "behavior"
            }
          ],
          "objectGroups": []
        },
        {
          "fullName": "",
          "functionType": "Action",
          "name": "doStepPostEvents",
          "sentence": "",
          "events": [
            {
              "disabled": true,
              "type": "BuiltinCommonInstructions::Standard",
              "conditions": [
                {
                  "type": {
                    "value": "BuiltinCommonInstructions::CompareNumbers"
                  },
                  "parameters": [
                    "abs(Object.PlatformerCharacter::CurrentSpeed())",
                    "!=",
                    "0"
                  ]
                },
                {
                  "type": {
                    "value": "BuiltinCommonInstructions::CompareNumbers"
                  },
                  "parameters": [
                    "abs(Object.PlatformerCharacter::CurrentSpeed())",
                    "!=",
                    "Object.PlatformerCharacter::MaxSpeed()"
                  ]
                }
              ],
              "actions": [
                {
                  "type": {
                    "value": "DebuggerTools::ConsoleLog"
                  },
                  "parameters": [
                    "ToString(abs(Object.Behavior::PropertyPreviousSpeedX()) - Object.PlatformerCharacter::Deceleration() * TimeDelta() - abs(Object.PlatformerCharacter::CurrentSpeed()))",
                    "",
                    ""
                  ]
                }
              ]
            },
            {
              "type": "BuiltinCommonInstructions::Comment",
              "color": {
                "b": 109,
                "g": 230,
                "r": 255,
                "textB": 0,
                "textG": 0,
                "textR": 0
              },
              "comment": "Check if the character is decelerating.\nIt's done in doStepPostEvent because there is no way to know if the doStepPreEvents of this behavior is executed before or after the one of PlatformerCharcter.\nAs TimeDelta is used, we have to be sure the last PlatformerCharcter.doStepPreEvents call used the same TimeDelta. Which means this must be done after PlatformerCharcter.doStepPreEvents.",
              "comment2": ""
            },
            {
              "type": "BuiltinCommonInstructions::Standard",
              "conditions": [],
              "actions": [
                {
                  "type": {
                    "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyIsDecelerating"
                  },
                  "parameters": [
                    "Object",
                    "Behavior",
                    "no"
                  ]
                }
              ]
            },
            {
              "type": "BuiltinCommonInstructions::Standard",
              "conditions": [
                {
                  "type": {
                    "value": "BuiltinCommonInstructions::Or"
                  },
                  "parameters": [],
                  "subInstructions": [
                    {
                      "type": {
                        "value": "PlatformBehavior::CurrentSpeed"
                      },
                      "parameters": [
                        "Object",
                        "PlatformerCharacter",
                        "=",
                        "0"
                      ]
                    },
                    {
                      "type": {
                        "value": "BuiltinCommonInstructions::CompareNumbers"
                      },
                      "parameters": [
                        "abs(Object.PlatformerCharacter::CurrentSpeed())",
                        "=",
                        "abs(Object.Behavior::PropertyPreviousSpeedX()) - Object.PlatformerCharacter::Deceleration() * TimeDelta()"
                      ]
                    }
                  ]
                }
              ],
              "actions": [
                {
                  "type": {
                    "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyIsDecelerating"
                  },
                  "parameters": [
                    "Object",
                    "Behavior",
                    "yes"
                  ]
                }
              ]
            },
            {
              "type": "BuiltinCommonInstructions::Comment",
              "color": {
                "b": 109,
                "g": 230,
                "r": 255,
                "textB": 0,
                "textG": 0,
                "textR": 0
              },
              "comment": "Save the speed to detect speed changes from outside.",
              "comment2": ""
            },
            {
              "type": "BuiltinCommonInstructions::Standard",
              "conditions": [],
              "actions": [
                {
                  "type": {
                    "value": "PixelPerfectMovement::PixelPerfectPlatformerCharacter::SetPropertyPreviousSpeedX"
                  },
                  "parameters": [
                    "Object",
                    "Behavior",
                    "=",
                    "Object.PlatformerCharacter::CurrentSpeed()"
                  ]
                }
              ]
            }
          ],
          "parameters": [
            {
              "description": "Object",
              "name": "Object",
              "type": "object"
            },
            {
              "description": "Behavior",
              "name": "Behavior",
              "supplementaryInformation": "PixelPerfectMovement::PixelPerfectPlatformerCharacter",
              "type": "behavior"
            }
          ],
          "objectGroups": []
        }
      ],
      "propertyDescriptors": [
        {
          "value": "",
          "type": "Behavior",
          "label": "Platformer character behavior",
          "description": "",
          "group": "",
          "extraInformation": [
            "PlatformBehavior::PlatformerObjectBehavior"
          ],
          "hidden": false,
          "name": "PlatformerCharacter"
        },
        {
          "value": "1",
          "type": "Number",
          "label": "Pixel size",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "PixelSize"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "Pixel grid offset X",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "OffsetX"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "Pixel grid offset Y",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": false,
          "name": "OffsetY"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "TargetX"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "TargetDirectionX"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "TargetY"
        },
        {
          "value": "0",
          "type": "Number",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "TargetDirectionY"
        },
        {
          "value": "",
          "type": "Number",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "PreviousSpeedX"
        },
        {
          "value": "",
          "type": "Boolean",
          "label": "",
          "description": "",
          "group": "",
          "extraInformation": [],
          "hidden": true,
          "name": "IsDecelerating"
        }
      ],
      "sharedPropertyDescriptors": []
    }
  ],
  "eventsBasedObjects": []
}