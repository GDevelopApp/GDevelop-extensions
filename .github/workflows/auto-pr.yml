name: Extension issue to Pull Request conversion
on:
  issues:
    types: [opened, labeled, edited]

jobs:
  generate-pr:
    # Only run it on extensions submissions (tag is ensured via the new issue form)
    if: ${{ contains(github.event.issue.labels.*.name, 'âœ¨ New extension') || contains(github.event.issue.labels.*.name, 'ðŸ”„ Extension update') }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Download extension
        env:
          BODY: ${{ github.event.issue.body }}
        run: |
          curl -L $(echo $BODY | grep -ioEh 'https?://\S+.zip' -m2 | tail -n1) -o /tmp/ext.zip
          unzip -o /tmp/ext.zip -d ./Extensions

      - name: Rebuild the database
        run: |
          npm install
          echo 'BUILD_LOGS<<EOF' >> $GITHUB_ENV
          node scripts/generate-extensions-registry.js --disable-exit-code >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Notify build errors
        if: ${{ !contains(env.BUILD_LOGS, 'successfully updated') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Hi @${{ github.actor }}! 

          Thanks for your submission! Unfortunately, our automated test system found a few issues with your extension:

          \`\`\`${{ env.BUILD_LOGS }}
          \`\`\`

          Please fix them, and edit the link in your original submission to a zip file with the fixed extension. 

          Thanks again for your hard work!"

      - name: Create Pull Request
        if: ${{ contains(env.BUILD_LOGS, 'successfully updated') }}
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: 'Automated Extension submission for issue #${{ github.event.issue.number }}'
          committer: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: extension/${{ github.actor }}/${{ github.event.issue.number }}
          delete-branch: true
          title: '[Auto PR] ${{ github.event.issue.title }}'
          body: ${{ github.event.issue.body }}
          labels: âœ¨ New extension

      - name: Add card to pending review
        if: ${{ contains(env.BUILD_LOGS, 'successfully updated') }}
        uses: peter-evans/create-or-update-project-card@v1
        with:
          project-name: Extensions review
          column-name: Needs review
          issue-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Close and comment on issue
        if: ${{ contains(env.BUILD_LOGS, 'successfully updated') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }}
          gh issue comment ${{ github.event.issue.number }} --body "Hi @${{ github.actor }}! ðŸ‘‹ This submission has been moved to a PR as part of our submission pipeline. [Please continue the submission process on this page](${{ steps.cpr.outputs.pull-request-url }}). A few commands can be used there, use \`!update <Link to your zipped extension>\` to update the extension in the PR, and \`!rebase\` to merge changes from the main branch into your PR. Thanks again for your submission!"

      - name: Notify any error
        if: ${{ failure() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "Oh no ðŸ˜±! An internal error has occured while running automated tests on your submission. See logs at https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}."
